apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: observability
spec:
  mode: deployment
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"

  # GRAFANA_AUTH comes from the otel-vendor-credentials secret.
  # Value is base64(instanceId:apiKey) — never committed to git.
  # To populate: printf '<instanceId>:<apiKey>' | base64
  # Then: kubectl create secret generic otel-vendor-credentials \
  #         -n observability --from-literal=GRAFANA_AUTH=<value>
  env:
    - name: GRAFANA_AUTH
      valueFrom:
        secretKeyRef:
          name: otel-vendor-credentials
          key: GRAFANA_AUTH

  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    exporters:
      # Log a summary to collector stdout — useful for verifying instrumentation.
      debug:
        verbosity: normal

      # Grafana Cloud OTLP gateway (prod-us-east-0)
      otlp_http/grafana:
        endpoint: https://otlp-gateway-prod-us-east-0.grafana.net/otlp
        headers:
          authorization: "Basic ${env:GRAFANA_AUTH}"

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
