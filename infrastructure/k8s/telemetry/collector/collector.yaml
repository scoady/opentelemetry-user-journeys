apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: observability
spec:
  mode: deployment
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"

  # Credentials come from the otel-vendor-credentials secret (never committed).
  # To populate:
  #   kubectl create secret generic otel-vendor-credentials \
  #     -n observability \
  #     --from-literal=GRAFANA_INSTANCE_ID=<instance-id> \
  #     --from-literal=GRAFANA_API_KEY=<glc_...token>
  env:
    - name: GRAFANA_INSTANCE_ID
      valueFrom:
        secretKeyRef:
          name: otel-vendor-credentials
          key: GRAFANA_INSTANCE_ID
    - name: GRAFANA_API_KEY
      valueFrom:
        secretKeyRef:
          name: otel-vendor-credentials
          key: GRAFANA_API_KEY

  config:
    extensions:
      # basicauth extension handles Grafana Cloud's Basic auth correctly.
      basicauth/grafana:
        client_auth:
          username: "${env:GRAFANA_INSTANCE_ID}"
          password: "${env:GRAFANA_API_KEY}"

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    exporters:
      # Log a summary to collector stdout â€” useful for verifying instrumentation.
      debug:
        verbosity: normal

      # Grafana Cloud OTLP gateway (prod-us-east-0)
      otlp_http/grafana:
        endpoint: https://otlp-gateway-prod-us-east-0.grafana.net/otlp
        auth:
          authenticator: basicauth/grafana

    service:
      extensions: [basicauth/grafana]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
