apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: observability
spec:
  mode: deployment
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Credentials come from the otel-vendor-credentials secret (never committed).
  # To populate:
  #   kubectl create secret generic otel-vendor-credentials \
  #     -n observability \
  #     --from-literal=GRAFANA_INSTANCE_ID=<instance-id> \
  #     --from-literal=GRAFANA_API_KEY=<glc_...token>
  env:
    - name: GRAFANA_INSTANCE_ID
      valueFrom:
        secretKeyRef:
          name: otel-vendor-credentials
          key: GRAFANA_INSTANCE_ID
    - name: GRAFANA_API_KEY
      valueFrom:
        secretKeyRef:
          name: otel-vendor-credentials
          key: GRAFANA_API_KEY

  config:
    extensions:
      basicauth/grafana:
        client_auth:
          username: "${env:GRAFANA_INSTANCE_ID}"
          password: "${env:GRAFANA_API_KEY}"

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    # The spanmetrics connector sits between the traces and metrics pipelines.
    # It derives RED metrics (rate, errors, duration) from every span, with
    # cuj.name as a first-class dimension so dashboards can filter by journey.
    #
    # Generated metric names (in Prometheus after OTLP ingestion):
    #   techmart_calls_total{span_name, service_name, status_code, cuj_name, ...}
    #   techmart_duration_milliseconds_bucket{...}   (+ _count, _sum)
    connectors:
      spanmetrics:
        namespace: techmart
        aggregation_temporality: "AGGREGATION_TEMPORALITY_CUMULATIVE"
        histogram:
          explicit:
            buckets: [10ms, 25ms, 50ms, 100ms, 250ms, 500ms, 1s, 2s, 5s, 10s]
        dimensions:
          - name: cuj.name
        metrics_flush_interval: 60s

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    exporters:
      debug:
        verbosity: basic

      otlp_http/grafana:
        endpoint: https://otlp-gateway-prod-us-east-0.grafana.net/otlp
        auth:
          authenticator: basicauth/grafana

    service:
      telemetry:
        logs:
          level: info
      extensions: [basicauth/grafana]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          # spanmetrics is a connector â€” it appears as an exporter here and
          # as a receiver in the metrics pipeline below.
          exporters: [debug, otlp_http/grafana, spanmetrics]
        metrics:
          receivers: [otlp, spanmetrics]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [debug, otlp_http/grafana]
