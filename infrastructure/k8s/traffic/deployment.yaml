apiVersion: apps/v1
kind: Deployment
metadata:
  name: k6-traffic
  namespace: webstore
  labels:
    app: k6-traffic
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k6-traffic
  template:
    metadata:
      labels:
        app: k6-traffic
    spec:
      # Don't inject OTel auto-instrumentation — k6 isn't a Node.js app
      containers:
        - name: k6
          image: grafana/k6:latest
          imagePullPolicy: Always
          # Loop forever: run a 12h test, brief pause, repeat.
          command: ["/bin/sh", "-c"]
          args:
            - |
              while true; do
                echo "[k6] Starting run: ${RPS} req/s"
                k6 run \
                  --env RPS=${RPS} \
                  --env TARGET_URL=${TARGET_URL} \
                  /scripts/test.js
                echo "[k6] Run complete — restarting in 5s"
                sleep 5
              done
          env:
            # RPS: requests per second — edit and rollout restart to change rate
            - name: RPS
              value: "5"
            - name: TARGET_URL
              value: "http://frontend.webstore.svc.cluster.local"
          volumeMounts:
            - name: k6-script
              mountPath: /scripts
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "500m"
      volumes:
        - name: k6-script
          configMap:
            name: k6-script
