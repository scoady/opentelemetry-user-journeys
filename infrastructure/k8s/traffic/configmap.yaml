apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-script
  namespace: webstore
data:
  test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Counter, Rate } from 'k6/metrics';

    // ── Configuration ────────────────────────────────────────────────────────
    const BASE_URL  = __ENV.TARGET_URL  || 'http://frontend.webstore.svc.cluster.local';
    const VU_COUNT  = parseInt(__ENV.VU_COUNT  || '10');
    // Traffic split: remaining VUs go to checkout scenario
    const BROWSE_VUS   = Math.ceil(VU_COUNT * 0.6);
    const CHECKOUT_VUS = Math.ceil(VU_COUNT * 0.3);
    const SPIKE_VUS    = VU_COUNT - BROWSE_VUS - CHECKOUT_VUS;

    const PRODUCT_IDS = [1, 2, 3, 4, 5, 6, 7, 8];

    // ── Custom metrics ───────────────────────────────────────────────────────
    const orderErrors   = new Counter('techmart_order_errors');
    const checkoutRate  = new Rate('techmart_checkout_success_rate');

    // ── Scenarios ────────────────────────────────────────────────────────────
    export const options = {
      scenarios: {
        // Steady browser traffic — users looking at products
        browse: {
          executor: 'constant-vus',
          vus: BROWSE_VUS,
          duration: '12h',
          tags: { scenario: 'browse' },
        },
        // Purchase flow — lower volume, more complex
        checkout: {
          executor: 'constant-vus',
          vus: CHECKOUT_VUS,
          duration: '12h',
          tags: { scenario: 'checkout' },
        },
        // Periodic spike — simulates flash sales / marketing pushes
        spike: {
          executor: 'ramping-vus',
          startVUs: 0,
          stages: [
            { duration: '1m',  target: SPIKE_VUS * 3 },
            { duration: '2m',  target: SPIKE_VUS * 3 },
            { duration: '1m',  target: 0 },
            { duration: '26m', target: 0 },   // quiet for 26m then repeat
          ],
          tags: { scenario: 'spike' },
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<2000'],
        http_req_failed:   ['rate<0.05'],
        techmart_checkout_success_rate: ['rate>0.9'],
      },
    };

    // ── Helpers ───────────────────────────────────────────────────────────────
    function randomItem(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const NAMES    = ['Alice', 'Bob', 'Carlos', 'Diana', 'Eve', 'Frank', 'Grace', 'Hiro'];
    const DOMAINS  = ['example.com', 'test.io', 'loadtest.dev'];
    const STREETS  = ['1 Main St', '42 Oak Ave', '7 Elm Rd', '99 Pine Blvd'];

    function randomCustomer() {
      const name = randomItem(NAMES);
      return {
        customer_name:    name,
        customer_email:   `${name.toLowerCase()}@${randomItem(DOMAINS)}`,
        shipping_address: randomItem(STREETS),
      };
    }

    // ── Browse scenario ───────────────────────────────────────────────────────
    export function browse() {
      // List products
      const listRes = http.get(`${BASE_URL}/api/products`);
      check(listRes, {
        'products 200': (r) => r.status === 200,
        'products json': (r) => r.headers['Content-Type'] && r.headers['Content-Type'].includes('json'),
      });

      sleep(randomInt(1, 4));

      // Simulate clicking into a product (if we add a detail endpoint later)
      // For now just re-hit the list a couple of times (tab navigation)
      if (Math.random() < 0.4) {
        http.get(`${BASE_URL}/api/products`);
        sleep(randomInt(1, 3));
      }

      // Health endpoint — simulates readiness probes / uptime monitors
      if (Math.random() < 0.1) {
        http.get(`${BASE_URL}/api/health`);
      }

      sleep(randomInt(1, 3));
    }

    // ── Checkout scenario ─────────────────────────────────────────────────────
    export function checkout() {
      // Step 1: browse products
      const listRes = http.get(`${BASE_URL}/api/products`);
      check(listRes, { 'products 200': (r) => r.status === 200 });
      sleep(randomInt(2, 5));

      // Step 2: "add to cart" — pick 1-3 products
      const itemCount = randomInt(1, 3);
      const items = [];
      const picked = new Set();
      while (items.length < itemCount) {
        const id = randomItem(PRODUCT_IDS);
        if (!picked.has(id)) {
          picked.add(id);
          items.push({ product_id: id, quantity: randomInt(1, 2) });
        }
      }

      sleep(randomInt(1, 3));

      // Step 3: submit order
      const payload = JSON.stringify({
        ...randomCustomer(),
        items,
      });

      const orderRes = http.post(`${BASE_URL}/api/orders`, payload, {
        headers: { 'Content-Type': 'application/json' },
      });

      const ok = check(orderRes, {
        'order 201': (r) => r.status === 201,
        'order has id': (r) => {
          try { return JSON.parse(r.body).id > 0; } catch { return false; }
        },
      });

      checkoutRate.add(ok);
      if (!ok) orderErrors.add(1);

      sleep(randomInt(2, 6));
    }

    // ── Spike scenario ────────────────────────────────────────────────────────
    export function spike() {
      http.get(`${BASE_URL}/api/products`);
      sleep(randomInt(0, 1));
    }

    // k6 needs a default export — route based on scenario tag
    export default function () {
      const scenario = __ENV.K6_SCENARIO_NAME;
      if (scenario === 'checkout') return checkout();
      if (scenario === 'spike')    return spike();
      return browse();
    }
