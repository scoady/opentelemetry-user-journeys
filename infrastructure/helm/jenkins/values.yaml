# ─────────────────────────────────────────────────────────────────────────────
# Jenkins Helm values — kind / local-dev defaults
# Chart: jenkins/jenkins  version: 5.8.3
#
# Access Jenkins at: http://jenkins.localhost
#   (setup-cicd.sh adds 127.0.0.1 jenkins.localhost to /etc/hosts)
#
# Admin password (auto-generated):
#   kubectl get secret jenkins -n cicd \
#     -o jsonpath='{.data.jenkins-admin-password}' | base64 -d
# ─────────────────────────────────────────────────────────────────────────────

controller:
  admin:
    username: admin

  # Pin to latest Jenkins LTS (jdk21) so plugins can install their latest
  # compatible versions without Jenkins-version mismatches.
  image:
    tag: "lts-jdk21"

  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

  javaOpts: "-Xms512m -Xmx1536m -Djenkins.install.runSetupWizard=false"

  # ── Plugins (no version pins — let Jenkins resolve compatible versions) ─────
  installPlugins:
    - kubernetes
    - workflow-aggregator
    - git
    - configuration-as-code
    - job-dsl
    - pipeline-stage-view
    - parameterized-trigger
    - credentials-binding

  installLatestPlugins: true
  overwritePlugins: true

  # ── Ingress (nginx) ─────────────────────────────────────────────────────────
  ingress:
    enabled: true
    ingressClassName: nginx
    hostName: jenkins.localhost
    annotations:
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"

  # ── Host repo mount ─────────────────────────────────────────────────────────
  # Mounts the local git repo read-only at /src/repo inside the controller pod.
  # Agent pods get the same mount via the JCasC pod templates below.
  # On macOS + Docker Desktop, /Users is shared into the Docker VM automatically
  # so this hostPath is accessible from kind nodes.
  volumes:
    - name: src-repo
      hostPath:
        path: /Users/ayx106492/git/otel-slos
        type: Directory

  containerVolumeMounts:
    - name: src-repo
      mountPath: /src/repo
      readOnly: true

  # ── JCasC ───────────────────────────────────────────────────────────────────
  JCasC:
    defaultConfig: true
    configScripts:

      # System message
      welcome-message: |
        jenkins:
          systemMessage: "TechMart CI/CD — kind dev cluster.\n\nPipelines auto-configured: techmart-build, techmart-deploy."

      # Kubernetes cloud + pod templates for Kaniko and Helm agents
      kubernetes-cloud: |
        jenkins:
          clouds:
            - kubernetes:
                name: "kubernetes"
                serverUrl: ""
                skipTlsVerify: false
                namespace: "cicd"
                # Use in-cluster DNS so agent pods can find the controller.
                # (jenkins.localhost only resolves on the Mac host, not inside pods.)
                jenkinsUrl: "http://jenkins.cicd.svc.cluster.local:8080"
                jenkinsTunnel: "jenkins-agent.cicd.svc.cluster.local:50000"
                connectTimeout: 5
                readTimeout: 15
                containerCapStr: "10"
                podRetention: "never"
                templates:

                  # ── kaniko-agent ───────────────────────────────────────────
                  # Two containers: jnlp (Jenkins agent) + kaniko (image builder).
                  # Both share an emptyDir workspace volume.
                  # kaniko image is the -debug variant — ships /busybox/cat which
                  # the Kubernetes plugin needs to keep the container alive until
                  # the build stage runs /kaniko/executor.
                  - name: "kaniko-agent"
                    label: "kaniko"
                    serviceAccount: "jenkins"
                    namespace: "cicd"
                    nodeUsageMode: "NORMAL"
                    workspaceVolume:
                      emptyDirWorkspaceVolume:
                        memory: false
                    volumes:
                      - hostPathVolume:
                          hostPath: "/Users/ayx106492/git/otel-slos"
                          mountPath: "/src/repo"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:3327.v868139a_d00e0-7"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "200m"
                        resourceRequestMemory: "256Mi"
                        resourceLimitCpu: "500m"
                        resourceLimitMemory: "512Mi"
                        ttyEnabled: false
                        envVars:
                          - envVar:
                              key: "HOME"
                              value: "/home/jenkins/agent"
                      - name: "kaniko"
                        image: "gcr.io/kaniko-project/executor:v1.23.2-debug"
                        alwaysPullImage: false
                        command: "/busybox/cat"
                        args: ""
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        resourceLimitCpu: "2000m"
                        resourceLimitMemory: "2Gi"

                  # ── helm-agent ─────────────────────────────────────────────
                  # Two containers: jnlp + alpine/helm (includes kubectl).
                  - name: "helm-agent"
                    label: "helm"
                    serviceAccount: "jenkins"
                    namespace: "cicd"
                    nodeUsageMode: "NORMAL"
                    workspaceVolume:
                      emptyDirWorkspaceVolume:
                        memory: false
                    volumes:
                      - hostPathVolume:
                          hostPath: "/Users/ayx106492/git/otel-slos"
                          mountPath: "/src/repo"
                    containers:
                      - name: "jnlp"
                        image: "jenkins/inbound-agent:3327.v868139a_d00e0-7"
                        alwaysPullImage: false
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "200m"
                        resourceRequestMemory: "256Mi"
                        resourceLimitCpu: "500m"
                        resourceLimitMemory: "512Mi"
                        ttyEnabled: false
                        envVars:
                          - envVar:
                              key: "HOME"
                              value: "/home/jenkins/agent"
                      - name: "helm"
                        image: "alpine/helm:3.16.4"
                        alwaysPullImage: false
                        command: "cat"
                        args: ""
                        ttyEnabled: true
                        workingDir: "/home/jenkins/agent"
                        resourceRequestCpu: "100m"
                        resourceRequestMemory: "128Mi"
                        resourceLimitCpu: "500m"
                        resourceLimitMemory: "512Mi"

      # Pre-create the two pipeline jobs using Job DSL.
      # techmart-build: builds images with Kaniko, then triggers techmart-deploy.
      # techmart-deploy: parameterized helm upgrade (IMAGE_TAG parameter).
      pipeline-jobs: |
        jobs:
          - script: >
              pipelineJob('techmart-build') {
                description('Build TechMart images with Kaniko and push to in-cluster registry, then deploy.')
                definition {
                  cpsScm {
                    scm {
                      git {
                        remote { url('file:///src/repo') }
                        branch('*/main')
                      }
                    }
                    scriptPath('ci/build.Jenkinsfile')
                  }
                }
                triggers {
                  scm('H/5 * * * *')
                }
                logRotator {
                  numToKeep(10)
                }
              }
          - script: >
              pipelineJob('techmart-deploy') {
                description('Deploy TechMart to the webstore namespace via helm upgrade.')
                parameters {
                  stringParam('IMAGE_TAG', 'latest', 'Git SHA tag to deploy (e.g. a1b2c3d)')
                }
                definition {
                  cpsScm {
                    scm {
                      git {
                        remote { url('file:///src/repo') }
                        branch('*/main')
                      }
                    }
                    scriptPath('ci/deploy.Jenkinsfile')
                  }
                }
                logRotator {
                  numToKeep(20)
                }
              }

      # Allow anonymous read — convenient for local dev dashboards.
      security: |
        jenkins:
          authorizationStrategy:
            loggedInUsersCanDoAnything:
              allowAnonymousRead: true
          securityRealm:
            local:
              allowsSignup: false
              users:
                - id: "admin"
                  name: "Admin"

# ── Agent defaults ───────────────────────────────────────────────────────────
agent:
  enabled: true
  namespace: cicd
  podRetention: "Never"
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# ── Persistence ──────────────────────────────────────────────────────────────
persistence:
  enabled: true
  size: 10Gi
  storageClass: standard
  accessMode: ReadWriteOnce

# ── RBAC ─────────────────────────────────────────────────────────────────────
rbac:
  create: true
  readSecrets: false

serviceAccount:
  create: true
  name: jenkins
