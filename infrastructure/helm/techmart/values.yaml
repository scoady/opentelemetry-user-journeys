# ─────────────────────────────────────────────────────────────────────────────
# TechMart Helm values — kind / local-dev defaults
#
# Deploy with:
#   helm upgrade --install techmart ./infrastructure/helm/techmart \
#     --namespace webstore --create-namespace \
#     --values ./infrastructure/helm/techmart/values.yaml
# ─────────────────────────────────────────────────────────────────────────────

# ── Global ────────────────────────────────────────────────────────────────────
global:
  # Registry prefix prepended to every image reference.
  # Empty (default) → no prefix, for the local build-and-load.sh workflow.
  # Jenkins CI sets this to: registry.registry.svc.cluster.local:5000
  imageRegistry: ""

# ── PostgreSQL ────────────────────────────────────────────────────────────────
postgres:
  image:
    repository: postgres
    tag: "16-alpine"

  # Override password in production via --set or a separate secrets file.
  credentials:
    database: techmart
    user: techmart
    password: techmart-secret-pw

  storage: 1Gi

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# ── API ───────────────────────────────────────────────────────────────────────
api:
  image:
    repository: webstore/api
    tag: latest
    # IfNotPresent: use the locally-loaded image if present, pull from a registry
    # otherwise. build-and-load.sh overrides tag with the git SHA so Helm detects
    # a spec change on every build and triggers a rolling update automatically.
    pullPolicy: IfNotPresent

  replicas: 2
  port: 3001

  otel:
    # Set to true to have the OTel Operator inject the Node.js SDK init container.
    # The Instrumentation CR is managed as part of this Helm chart.
    injectNodejs: true

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"

# ── Frontend ──────────────────────────────────────────────────────────────────
frontend:
  image:
    repository: webstore/frontend
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 2

  ingress:
    enabled: true
    className: nginx
    # Leave host empty to match all incoming hostnames (default for kind / localhost).
    # Set to a real hostname for production, e.g. techmart.example.com
    host: ""

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

# ── Inventory service ─────────────────────────────────────────────────────────
inventorySvc:
  image:
    repository: webstore/inventory-svc
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 1
  port: 3002

  # Simulated inventory DB latency in milliseconds.
  # Change live without redeploying:
  #   helm upgrade techmart ./infrastructure/helm/techmart \
  #     --namespace webstore --reuse-values \
  #     --set inventorySvc.artificialDelayMs=1500
  artificialDelayMs: 500

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "250m"

# ── Kafka (single-broker KRaft, no Zookeeper) ────────────────────────────────
kafka:
  image:
    repository: apache/kafka
    tag: "3.9.0"

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

# ── Product Worker (Kafka consumer) ──────────────────────────────────────────
productWorker:
  image:
    repository: webstore/product-worker
    tag: latest
    pullPolicy: IfNotPresent

  replicas: 1

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "250m"

# ── Traffic generator (k6) ────────────────────────────────────────────────────
traffic:
  # Set to false to deploy without synthetic load (e.g. production).
  enabled: true

  # Requests per second. Adjust and run `helm upgrade` to change live.
  rps: 5

  # Target base URL. Override if deploying outside kind.
  targetUrl: "http://frontend.webstore.svc.cluster.local"

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "500m"
