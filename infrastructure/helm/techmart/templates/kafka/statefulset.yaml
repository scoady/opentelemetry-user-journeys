apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "techmart.labels" . | nindent 4 }}
    app: kafka
    app.kubernetes.io/component: kafka
spec:
  replicas: 1
  serviceName: kafka
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
        app.kubernetes.io/component: kafka
    spec:
      initContainers:
        - name: kraft-format
          image: "{{ .Values.kafka.image.repository }}:{{ .Values.kafka.image.tag }}"
          command:
            - sh
            - -c
            - |
              # Copy the mounted server.properties so the broker can write to it
              cp /etc/kafka-config/server.properties /opt/kafka/config/kraft/server.properties

              # Generate a cluster ID and format the log directory (idempotent â€” skips if already formatted)
              CLUSTER_ID=$(/opt/kafka/bin/kafka-storage.sh random-uuid)
              /opt/kafka/bin/kafka-storage.sh format \
                --config /opt/kafka/config/kraft/server.properties \
                --cluster-id "$CLUSTER_ID" \
                --ignore-formatted
          volumeMounts:
            - name: kafka-config
              mountPath: /etc/kafka-config
            - name: kafka-data
              mountPath: /var/kafka-data
      containers:
        - name: kafka
          image: "{{ .Values.kafka.image.repository }}:{{ .Values.kafka.image.tag }}"
          command:
            - sh
            - -c
            - |
              cp /etc/kafka-config/server.properties /opt/kafka/config/kraft/server.properties
              exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties
          ports:
            - containerPort: 9092
              name: plaintext
            - containerPort: 9093
              name: controller
          volumeMounts:
            - name: kafka-config
              mountPath: /etc/kafka-config
            - name: kafka-data
              mountPath: /var/kafka-data
          readinessProbe:
            tcpSocket:
              port: 9092
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 9092
            initialDelaySeconds: 30
            periodSeconds: 15
          resources:
            {{- toYaml .Values.kafka.resources | nindent 12 }}
      volumes:
        - name: kafka-config
          configMap:
            name: kafka-config
        - name: kafka-data
          emptyDir: {}
