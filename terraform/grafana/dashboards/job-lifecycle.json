{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus (Mimir)",
      "description": "Grafana Cloud Prometheus / Mimir — spanmetrics land here",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    },
    {
      "name": "DS_TEMPO",
      "label": "Tempo",
      "description": "Grafana Cloud Tempo — traces land here",
      "type": "datasource",
      "pluginId": "tempo",
      "pluginName": "Tempo"
    }
  ],
  "__requires": [
    { "type": "grafana",    "id": "grafana",    "name": "Grafana",     "version": "10.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus",  "version": "1.0.0"  },
    { "type": "datasource", "id": "tempo",      "name": "Tempo",       "version": "1.0.0"  },
    { "type": "panel",      "id": "traces",     "name": "Traces",      "version": ""       },
    { "type": "panel",      "id": "table",      "name": "Table",       "version": ""       },
    { "type": "panel",      "id": "stat",       "name": "Stat",        "version": ""       },
    { "type": "panel",      "id": "timeseries", "name": "Time series", "version": ""       }
  ],
  "title": "TechMart — Job Lifecycle Explorer",
  "description": "Paste a trace ID to visualize the full product-upload job lifecycle: span waterfall, latency breakdown, error status, and SLO context for both upload and processing phases.",
  "uid": "techmart-job-lifecycle",
  "version": 1,
  "schemaVersion": 38,
  "tags": ["techmart", "job", "traces", "tempo", "product-upload"],
  "time": { "from": "now-1h", "to": "now" },
  "refresh": "30s",
  "templating": {
    "list": [
      {
        "name": "tempo",
        "type": "datasource",
        "query": "tempo",
        "label": "Tempo",
        "hide": 0,
        "current": {}
      },
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "label": "Prometheus",
        "hide": 0,
        "current": {}
      },
      {
        "name": "traceId",
        "type": "textbox",
        "label": "Trace ID",
        "current": { "text": "", "value": "" },
        "hide": 0,
        "options": [{ "text": "", "value": "", "selected": true }]
      }
    ]
  },
  "panels": [

    {
      "type": "row", "id": 100,
      "title": "Job Trace",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 },
      "collapsed": false, "panels": []
    },

    {
      "type": "traces", "id": 1,
      "title": "Trace Waterfall",
      "description": "Full span hierarchy for the job trace. Shows HTTP request → cuj.product-upload → Kafka produce → Kafka consume → cuj.product-upload-job → DB queries, with per-span duration bars and error highlighting.",
      "gridPos": { "x": 0, "y": 1, "w": 24, "h": 18 },
      "datasource": { "type": "tempo", "uid": "${tempo}" },
      "targets": [
        {
          "datasource": { "type": "tempo", "uid": "${tempo}" },
          "queryType": "traceql",
          "query": "${traceId}",
          "refId": "A"
        }
      ]
    },

    {
      "type": "row", "id": 101,
      "title": "Span Breakdown",
      "gridPos": { "x": 0, "y": 20, "w": 24, "h": 1 },
      "collapsed": false, "panels": []
    },

    {
      "type": "table", "id": 2,
      "title": "Span Details",
      "description": "All spans in the trace with name, service, duration, and status. Sort by duration to find the slowest spans.",
      "gridPos": { "x": 0, "y": 21, "w": 24, "h": 8 },
      "datasource": { "type": "tempo", "uid": "${tempo}" },
      "targets": [
        {
          "datasource": { "type": "tempo", "uid": "${tempo}" },
          "queryType": "traceql",
          "query": "{trace:id=\"${traceId}\"}",
          "refId": "A",
          "tableType": "spans"
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [{ "displayName": "Duration", "desc": true }]
      }
    },

    {
      "type": "row", "id": 102,
      "title": "Upload Phase — SLO Context (cuj.product-upload)",
      "gridPos": { "x": 0, "y": 30, "w": 24, "h": 1 },
      "collapsed": false, "panels": []
    },

    {
      "type": "stat", "id": 3,
      "title": "Upload Success Rate (1h)",
      "description": "Percentage of product-upload requests completing without error in the last hour.",
      "gridPos": { "x": 0, "y": 31, "w": 4, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [{
        "expr": "100 * sum(increase(techmart_calls_total{span_name=\"cuj.product-upload\", status_code!=\"STATUS_CODE_ERROR\"}[1h])) / sum(increase(techmart_calls_total{span_name=\"cuj.product-upload\"}[1h]))",
        "legendFormat": "",
        "refId": "A"
      }],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent", "decimals": 2, "min": 99, "max": 100,
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "red",    "value": null  },
            { "color": "yellow", "value": 99.5  },
            { "color": "green",  "value": 99.9  }
          ]}
        }
      }
    },

    {
      "type": "stat", "id": 4,
      "title": "Upload p99 Latency",
      "description": "99th percentile latency for the product-upload CUJ. SLO target: < 2s.",
      "gridPos": { "x": 4, "y": 31, "w": 4, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [{
        "expr": "histogram_quantile(0.99, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload\"}[5m])) by (le))",
        "legendFormat": "",
        "refId": "A"
      }],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" },
      "fieldConfig": {
        "defaults": {
          "unit": "ms", "decimals": 0,
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "green",  "value": null },
            { "color": "yellow", "value": 1500 },
            { "color": "red",    "value": 2000 }
          ]}
        }
      }
    },

    {
      "type": "timeseries", "id": 5,
      "title": "Upload Latency Percentiles",
      "description": "p50 / p95 / p99 latency trends for the product-upload CUJ. Dashed red line = 2s SLO target.",
      "gridPos": { "x": 8, "y": 31, "w": 16, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "histogram_quantile(0.5, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload\"}[5m])) by (le))",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload\"}[5m])) by (le))",
          "legendFormat": "p95",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload\"}[5m])) by (le))",
          "legendFormat": "p99",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never",
            "thresholdsStyle": { "mode": "dashed" }
          },
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "green", "value": null },
            { "color": "red",   "value": 2000 }
          ]}
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "p50" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#73BF69", "mode": "fixed" } }]
          },
          {
            "matcher": { "id": "byName", "options": "p95" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#FADE2A", "mode": "fixed" } }]
          },
          {
            "matcher": { "id": "byName", "options": "p99" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#F2495C", "mode": "fixed" } }]
          }
        ]
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    },

    {
      "type": "row", "id": 103,
      "title": "Processing Phase — SLO Context (cuj.product-upload-job)",
      "gridPos": { "x": 0, "y": 38, "w": 24, "h": 1 },
      "collapsed": false, "panels": []
    },

    {
      "type": "stat", "id": 6,
      "title": "Processing Success Rate (1h)",
      "description": "Percentage of product-upload-job spans completing without error in the last hour.",
      "gridPos": { "x": 0, "y": 39, "w": 4, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [{
        "expr": "100 * sum(increase(techmart_calls_total{span_name=\"cuj.product-upload-job\", status_code!=\"STATUS_CODE_ERROR\"}[1h])) / sum(increase(techmart_calls_total{span_name=\"cuj.product-upload-job\"}[1h]))",
        "legendFormat": "",
        "refId": "A"
      }],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent", "decimals": 2, "min": 99, "max": 100,
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "red",    "value": null  },
            { "color": "yellow", "value": 99.5  },
            { "color": "green",  "value": 99.9  }
          ]}
        }
      }
    },

    {
      "type": "stat", "id": 7,
      "title": "Processing p99 Latency",
      "description": "99th percentile latency for the product-upload-job CUJ (Kafka consume → batch INSERT). SLO target: < 10s.",
      "gridPos": { "x": 4, "y": 39, "w": 4, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [{
        "expr": "histogram_quantile(0.99, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload-job\"}[5m])) by (le))",
        "legendFormat": "",
        "refId": "A"
      }],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" },
      "fieldConfig": {
        "defaults": {
          "unit": "ms", "decimals": 0,
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "green",  "value": null  },
            { "color": "yellow", "value": 7500  },
            { "color": "red",    "value": 10000 }
          ]}
        }
      }
    },

    {
      "type": "timeseries", "id": 8,
      "title": "Processing Latency Percentiles",
      "description": "p50 / p95 / p99 latency trends for the product-upload-job CUJ (Kafka consume → batch INSERT → job completion). Dashed red line = 10s SLO target.",
      "gridPos": { "x": 8, "y": 39, "w": 16, "h": 6 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "histogram_quantile(0.5, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload-job\"}[5m])) by (le))",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload-job\"}[5m])) by (le))",
          "legendFormat": "p95",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(techmart_duration_milliseconds_bucket{span_name=\"cuj.product-upload-job\"}[5m])) by (le))",
          "legendFormat": "p99",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never",
            "thresholdsStyle": { "mode": "dashed" }
          },
          "thresholds": { "mode": "absolute", "steps": [
            { "color": "green", "value": null  },
            { "color": "red",   "value": 10000 }
          ]}
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "p50" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#73BF69", "mode": "fixed" } }]
          },
          {
            "matcher": { "id": "byName", "options": "p95" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#FADE2A", "mode": "fixed" } }]
          },
          {
            "matcher": { "id": "byName", "options": "p99" },
            "properties": [{ "id": "color", "value": { "fixedColor": "#F2495C", "mode": "fixed" } }]
          }
        ]
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom" },
        "tooltip": { "mode": "multi" }
      }
    }

  ]
}
